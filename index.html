<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AYExpenseTracker</title>
    <base href="/AYExpenseTracker/" />
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/app.css" />
    <link rel="icon" type="image/png" href="wallet.png" />
    <link href="AYExpenseTracker.styles.css" rel="stylesheet" />
</head>

<body>
    <div id="app"></div>

    <div id="blazor-error-ui">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">ðŸ—™</span>
    </div>

    <script src="_framework/blazor.webassembly.js"></script>
    <script src="js/site.js"></script>

    <!-- XLSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        window.downloadExcelFromBlazor = function (filename, json) {
            const ws = XLSX.utils.json_to_sheet(JSON.parse(json));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Expenses");
            XLSX.writeFile(wb, filename);
        };
    </script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        window.renderExpensesChart = (ctxId, labels, data) => {
            const ctx = document.getElementById(ctxId).getContext('2d');
            if (window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Expenses',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.6)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index' }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        };
    </script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBclK8VdNQN8GUFVyADmX_--bWJSFb7-Dk",
            authDomain: "ayexpensetracker.firebaseapp.com",
            projectId: "ayexpensetracker"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();

        // -------------------- ReCAPTCHA --------------------
        window.initializeRecaptcha = function () {
            if (!window.recaptchaVerifier) {
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    size: 'normal', // visible
                    callback: function (response) {
                        console.log('reCAPTCHA solved', response);
                    },
                    'expired-callback': function () {
                        console.log('reCAPTCHA expired, retry');
                    }
                });
                window.recaptchaVerifier.render();
            }
        };

        // -------------------- Phone OTP --------------------
        window.sendPhoneOtp = async function (phoneNumber) {
            try {
                window.initializeRecaptcha();
                const confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier);
                window.confirmationResult = confirmationResult;
                return true;
            } catch (err) {
                console.error("Phone OTP Error:", err);
                return false;
            }
        };

        window.verifyPhoneOtp = async function (code) {
            try {
                const result = await window.confirmationResult.confirm(code);
                return await result.user.getIdToken();
            } catch (err) {
                console.error("OTP Verification Error:", err);
                return null;
            }
        };

        // -------------------- Google Login --------------------
        window.signInWithGoogle = async function () {
            try {
                const provider = new firebase.auth.GoogleAuthProvider();
                const result = await auth.signInWithPopup(provider);
                const idToken = await result.user.getIdToken();
                if (DotNet && DotNet.invokeMethodAsync) {
                    await DotNet.invokeMethodAsync('AYExpenseTracker', 'ReceiveGoogleIdToken', idToken);
                }
            } catch (err) {
                console.error("Google Sign-In Error:", err);
            }
        };
    </script>
</body>
</html>
